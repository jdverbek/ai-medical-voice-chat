<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Medische Gesprek Assistent</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">🤖</div>
                    <h1>AI Medische Gesprek Assistent</h1>
                </div>
                <div class="header-controls">
                    <button id="settingsBtn" class="icon-btn" title="Instellingen">
                        ⚙️
                    </button>
                    <button id="helpBtn" class="icon-btn" title="Help">
                        ❓
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="screen active">
                <div class="welcome-content">
                    <div class="welcome-icon">👨‍⚕️</div>
                    <h2>Welkom bij uw AI Medische Assistent</h2>
                    <p class="welcome-description">
                        Ik ben een geavanceerde AI-assistent die u helpt bij het verzamelen van uw medische geschiedenis. 
                        Ik stel intelligente vragen die aangepast zijn aan uw antwoorden, net zoals een echte dokter zou doen.
                    </p>
                    
                    <div class="features-grid">
                        <div class="feature-card">
                            <div class="feature-icon">🎤</div>
                            <h3>Spraakherkenning</h3>
                            <p>Spreek natuurlijk in het Nederlands of Vlaams</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">🧠</div>
                            <h3>Intelligente Vragen</h3>
                            <p>Dynamische follow-up vragen gebaseerd op uw antwoorden</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">🔒</div>
                            <h3>Veilig & Privé</h3>
                            <p>GDPR-compliant en medisch vertrouwelijk</p>
                        </div>
                    </div>

                    <div class="start-options">
                        <button id="startVoiceChat" class="primary-btn large" onclick="startVoiceConversation()">
                            <span class="btn-icon">🎤</span>
                            Start Spraakgesprek
                        </button>
                        <button id="startTextChat" class="secondary-btn large" onclick="startTextConversation()">
                            <span class="btn-icon">💬</span>
                            Start Tekstgesprek
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Interface -->
            <div id="chatScreen" class="screen">
                <div class="chat-container">
                    <!-- Chat Header -->
                    <div class="chat-header">
                        <button id="backBtn" class="icon-btn">
                            ← Terug
                        </button>
                        <div class="chat-info">
                            <h3 id="chatTitle">Medisch Gesprek</h3>
                            <p id="chatStatus">Klaar om te beginnen</p>
                        </div>
                        <div class="chat-controls">
                            <button id="toggleModeBtn" class="mode-btn">
                                <span id="modeIcon">🎤</span>
                                <span id="modeText">Spraak</span>
                            </button>
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages will be dynamically added here -->
                    </div>

                    <!-- Chat Input -->
                    <div class="chat-input-container">
                        <!-- Voice Input -->
                        <div id="voiceInput" class="input-section active">
                            <div class="voice-visualizer">
                                <div class="voice-animation" id="voiceAnimation">
                                    <div class="voice-wave"></div>
                                    <div class="voice-wave"></div>
                                    <div class="voice-wave"></div>
                                    <div class="voice-wave"></div>
                                    <div class="voice-wave"></div>
                                </div>
                            </div>
                            <div class="voice-controls">
                                <button id="recordBtn" class="record-btn">
                                    <span class="record-icon">🎤</span>
                                    <span class="record-text">Druk om te spreken</span>
                                </button>
                            </div>
                            <div class="voice-feedback" id="voiceFeedback">
                                Druk op de microfoon en begin te spreken...
                            </div>
                        </div>

                        <!-- Text Input -->
                        <div id="textInput" class="input-section">
                            <div class="text-input-wrapper">
                                <textarea 
                                    id="messageInput" 
                                    placeholder="Typ uw antwoord hier..."
                                    rows="3"
                                ></textarea>
                                <button id="sendBtn" class="send-btn" disabled>
                                    <span>Verstuur</span>
                                    <span class="send-icon">→</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Screen -->
            <div id="summaryScreen" class="screen">
                <div class="summary-content">
                    <div class="summary-header">
                        <div class="summary-icon">📋</div>
                        <h2>Gesprek Samenvatting</h2>
                        <p>Hier is een overzicht van uw medische informatie</p>
                    </div>
                    
                    <div class="summary-sections" id="summaryContent">
                        <!-- Summary content will be dynamically generated -->
                    </div>

                    <div class="summary-actions">
                        <button id="editSummaryBtn" class="secondary-btn">
                            Bewerken
                        </button>
                        <button id="completeSummaryBtn" class="primary-btn">
                            Voltooien
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modals -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Instellingen</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="setting-group">
                        <label>Spraaksnelheid</label>
                        <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="0.8">
                    </div>
                    <div class="setting-group">
                        <label>Spraakvolume</label>
                        <input type="range" id="speechVolume" min="0" max="1" step="0.1" value="1">
                    </div>
                    <div class="setting-group">
                        <label>Tekstgrootte</label>
                        <select id="fontSize">
                            <option value="normal">Normaal</option>
                            <option value="large">Groot</option>
                            <option value="extra-large">Extra Groot</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div id="helpModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Help & Instructies</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="help-section">
                        <h4>Hoe werkt het?</h4>
                        <p>Deze AI-assistent stelt intelligente vragen over uw gezondheid. De vragen passen zich aan op basis van uw antwoorden, net zoals een echte dokter zou doen.</p>
                    </div>
                    <div class="help-section">
                        <h4>Spraakfunctie</h4>
                        <p>Druk op de microfoon en spreek duidelijk. De assistent begrijpt Nederlands en Vlaams, inclusief regionale dialecten.</p>
                    </div>
                    <div class="help-section">
                        <h4>Privacy</h4>
                        <p>Uw gegevens worden veilig verwerkt volgens GDPR-richtlijnen. Spraakopnames worden niet opgeslagen.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>AI denkt na...</p>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="medical-knowledge.js"></script>
    <script src="conversation-engine.js"></script>
    <script src="whisper-voice-handler.js"></script>
    <script src="app.js"></script>
</body>
</html>


    <script>
        // Voice recording variables
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        
        // Simple inline functions to handle button clicks
        function startVoiceConversation() {
            console.log('Starting voice conversation...');
            showChatInterface('voice');
        }
        
        function startTextConversation() {
            console.log('Starting text conversation...');
            showChatInterface('text');
        }
        
        function showChatInterface(mode) {
            // Hide welcome screen
            document.getElementById('welcomeScreen').classList.remove('active');
            // Show chat screen
            document.getElementById('chatScreen').classList.add('active');
            
            // Add initial AI message
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                const welcomeMessage = document.createElement('div');
                welcomeMessage.className = 'message ai-message';
                welcomeMessage.innerHTML = `
                    <div class="message-avatar">🤖</div>
                    <div class="message-content">
                        <div class="message-text">Welkom! Ik help u bij het verzamelen van uw medische informatie. Wat is uw hoofdklacht vandaag?</div>
                    </div>
                `;
                chatMessages.appendChild(welcomeMessage);
            }
            
            // Show appropriate input mode
            if (mode === 'text') {
                document.getElementById('voiceInput').classList.remove('active');
                document.getElementById('textInput').classList.add('active');
            } else {
                document.getElementById('textInput').classList.remove('active');
                document.getElementById('voiceInput').classList.add('active');
                // Initialize voice recording
                initializeVoiceRecording();
            }
        }
        
        async function initializeVoiceRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('Microphone access granted');
                
                // Setup the record button
                const recordBtn = document.getElementById('recordBtn');
                if (recordBtn) {
                    recordBtn.onclick = toggleRecording;
                    recordBtn.disabled = false;
                    updateVoiceFeedback('Druk op de microfoon om te beginnen spreken...');
                }
            } catch (error) {
                console.error('Microphone access denied:', error);
                // Fallback: Add test audio functionality
                setupTestAudioFallback();
            }
        }
        
        function setupTestAudioFallback() {
            updateVoiceFeedback('⚠️ Geen microfoon beschikbaar. Test modus actief.');
            
            // Add test audio button
            const voiceInput = document.getElementById('voiceInput');
            if (voiceInput) {
                const testContainer = document.createElement('div');
                testContainer.className = 'test-audio-container';
                testContainer.innerHTML = `
                    <div class="test-audio-info">
                        <p>🧪 Test Modus - Simuleer spraakherkenning</p>
                        <button id="testAudioBtn" class="test-audio-btn">
                            🎤 Test Spraakherkenning
                        </button>
                    </div>
                `;
                voiceInput.appendChild(testContainer);
                
                // Setup test button
                document.getElementById('testAudioBtn').onclick = simulateVoiceInput;
            }
        }
        
        function simulateVoiceInput() {
            // Simulate different medical complaints for testing
            const testPhrases = [
                "Ik heb hoofdpijn sinds gisteren",
                "Mijn keel doet pijn en ik heb koorts",
                "Ik voel me duizelig en misselijk",
                "Ik heb pijn op mijn borst",
                "Ik ben erg moe de laatste tijd",
                "Ik heb buikpijn na het eten",
                "Mijn rug doet pijn",
                "Ik heb last van hoesten"
            ];
            
            const randomPhrase = testPhrases[Math.floor(Math.random() * testPhrases.length)];
            
            updateVoiceFeedback('🎤 Simuleren: "' + randomPhrase + '"');
            
            // Simulate processing delay
            setTimeout(() => {
                addUserMessage(randomPhrase);
                setTimeout(() => addAIResponse(randomPhrase), 1000);
                updateVoiceFeedback('✅ Test voltooid! Klik opnieuw voor een andere test.');
            }, 1500);
        }
        
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    processAudioWithWhisper(audioBlob);
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // Update UI
                const recordBtn = document.getElementById('recordBtn');
                if (recordBtn) {
                    recordBtn.innerHTML = `
                        <span class="record-icon">⏹️</span>
                        <span class="record-text">Stop opname</span>
                    `;
                    recordBtn.classList.add('recording');
                }
                
                updateVoiceFeedback('🎤 Aan het opnemen... Druk nogmaals om te stoppen.');
                
            } catch (error) {
                console.error('Error starting recording:', error);
                updateVoiceFeedback('Fout bij het starten van de opname.');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // Stop all tracks
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                // Update UI
                const recordBtn = document.getElementById('recordBtn');
                if (recordBtn) {
                    recordBtn.innerHTML = `
                        <span class="record-icon">🎤</span>
                        <span class="record-text">Druk om te spreken</span>
                    `;
                    recordBtn.classList.remove('recording');
                }
                
                updateVoiceFeedback('⏳ Verwerken van spraak...');
            }
        }
        
        async function processAudioWithWhisper(audioBlob) {
            try {
                updateVoiceFeedback('🔄 Versturen naar Whisper API...');
                
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.wav');
                formData.append('language', 'nl');
                formData.append('prompt', 'Dit is een medisch gesprek in het Nederlands.');
                
                const response = await fetch('/api/whisper/transcribe', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                console.log('Whisper API Response:', result);
                
                if (response.ok && result.transcript && result.transcript.trim()) {
                    // Success - add user message with transcription
                    addUserMessage(result.transcript);
                    // Generate AI response
                    setTimeout(() => addAIResponse(result.transcript), 1000);
                    updateVoiceFeedback('✅ Spraak verwerkt: "' + result.transcript + '"');
                } else {
                    // Handle different error cases
                    let errorMessage = '❌ Spraakherkenning mislukt.';
                    
                    if (result.error) {
                        if (result.error.includes('Invalid file format')) {
                            errorMessage = '❌ Audio formaat niet ondersteund. Probeer opnieuw.';
                        } else if (result.error.includes('API key')) {
                            errorMessage = '❌ API configuratie probleem.';
                        } else {
                            errorMessage = '❌ ' + result.error.substring(0, 50) + '...';
                        }
                    }
                    
                    updateVoiceFeedback(errorMessage + ' Probeer opnieuw.');
                    
                    // Offer fallback option
                    setTimeout(() => {
                        updateVoiceFeedback('💡 Tip: Probeer de test modus als spraakherkenning niet werkt.');
                    }, 3000);
                }
            } catch (error) {
                console.error('Error processing audio:', error);
                updateVoiceFeedback('❌ Netwerkfout. Controleer uw verbinding en probeer opnieuw.');
                
                // Offer fallback after network error
                setTimeout(() => {
                    updateVoiceFeedback('🔄 Druk opnieuw om het nogmaals te proberen.');
                }, 2000);
            }
        }
        
        function updateVoiceFeedback(message) {
            const voiceFeedback = document.getElementById('voiceFeedback');
            if (voiceFeedback) {
                voiceFeedback.textContent = message;
            }
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, app ready...');
            
            // Add send button functionality
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');
            
            if (sendBtn && messageInput) {
                sendBtn.addEventListener('click', function() {
                    const text = messageInput.value.trim();
                    if (text) {
                        addUserMessage(text);
                        messageInput.value = '';
                        setTimeout(() => addAIResponse(text), 1000);
                    }
                });
                
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendBtn.click();
                    }
                });
                
                messageInput.addEventListener('input', function() {
                    sendBtn.disabled = !this.value.trim();
                });
            }
        });
        
        function addUserMessage(text) {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                const userMessage = document.createElement('div');
                userMessage.className = 'message user-message';
                userMessage.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">${text}</div>
                    </div>
                    <div class="message-avatar">👤</div>
                `;
                chatMessages.appendChild(userMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        function addAIResponse(userText) {
            // Store user input for intelligent processing
            if (!window.medicalData) {
                window.medicalData = {
                    symptoms: [],
                    duration: '',
                    severity: '',
                    medications: [],
                    history: [],
                    responses: []
                };
            }
            
            // Process user input intelligently
            const processedResponse = processUserInput(userText);
            window.medicalData.responses.push({
                user: userText,
                timestamp: new Date().toISOString()
            });
            
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                const aiMessage = document.createElement('div');
                aiMessage.className = 'message ai-message';
                aiMessage.innerHTML = `
                    <div class="message-avatar">🤖</div>
                    <div class="message-content">
                        <div class="message-text">${processedResponse}</div>
                        <div class="message-actions">
                            <button class="speak-btn" onclick="speakText('${processedResponse.replace(/'/g, "\\'")}')">
                                🔊 Herhaal
                            </button>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(aiMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Automatically speak the response in voice mode with faster speed
                if (document.getElementById('voiceInput').classList.contains('active')) {
                    setTimeout(() => speakText(processedResponse), 500);
                }
                
                // Check if we have enough information for summary
                if (window.medicalData.responses.length >= 5) {
                    setTimeout(() => showMedicalSummary(), 2000);
                }
            }
        }
        
        // Intelligent conversation processing
        function processUserInput(userText) {
            const text = userText.toLowerCase();
            const data = window.medicalData;
            
            // Extract symptoms
            const symptomKeywords = ['pijn', 'hoofdpijn', 'buikpijn', 'koorts', 'hoest', 'verkouden', 'moe', 'duizelig', 'misselijk', 'braken', 'diarree', 'constipatie', 'jeuk', 'uitslag', 'zwelling', 'kortademig'];
            symptomKeywords.forEach(symptom => {
                if (text.includes(symptom) && !data.symptoms.includes(symptom)) {
                    data.symptoms.push(symptom);
                }
            });
            
            // Extract duration
            const durationPatterns = ['dagen', 'weken', 'maanden', 'jaar', 'gisteren', 'vandaag', 'week geleden'];
            durationPatterns.forEach(duration => {
                if (text.includes(duration) && !data.duration) {
                    data.duration = duration;
                }
            });
            
            // Extract medications
            const medicationKeywords = ['medicijn', 'pil', 'tablet', 'paracetamol', 'ibuprofen', 'antibiotica', 'insuline'];
            medicationKeywords.forEach(med => {
                if (text.includes(med) && !data.medications.includes(med)) {
                    data.medications.push(med);
                }
            });
            
            // Generate intelligent follow-up based on collected data
            if (data.symptoms.length === 0) {
                return "Kunt u mij vertellen wat uw hoofdklacht is? Welke symptomen ervaart u?";
            } else if (!data.duration) {
                return `U heeft ${data.symptoms.join(' en ')} genoemd. Hoe lang heeft u hier al last van?`;
            } else if (data.symptoms.includes('pijn') && !data.severity) {
                return "Kunt u de pijn beschrijven? Is het een scherpe, doffe, of kloppende pijn? Op een schaal van 1 tot 10?";
            } else if (data.medications.length === 0) {
                return "Gebruikt u momenteel medicijnen voor deze klachten of andere aandoeningen?";
            } else if (data.history.length === 0) {
                return "Heeft u deze klachten eerder gehad? Heeft u bekende allergieën of chronische aandoeningen?";
            } else {
                return "Dank u voor de informatie. Is er nog iets anders dat u wilt vermelden over uw klachten?";
            }
        }
        
        // Show medical summary
        function showMedicalSummary() {
            const data = window.medicalData;
            let summary = "📋 **Medische Samenvatting:**\\n\\n";
            
            if (data.symptoms.length > 0) {
                summary += `**Symptomen:** ${data.symptoms.join(', ')}\\n`;
            }
            if (data.duration) {
                summary += `**Duur:** ${data.duration}\\n`;
            }
            if (data.medications.length > 0) {
                summary += `**Medicijnen:** ${data.medications.join(', ')}\\n`;
            }
            
            summary += "\\n**Aanbeveling:** Raadpleeg uw huisarts voor een professionele diagnose.";
            
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                const summaryMessage = document.createElement('div');
                summaryMessage.className = 'message ai-message summary-message';
                summaryMessage.innerHTML = `
                    <div class="message-avatar">📋</div>
                    <div class="message-content">
                        <div class="message-text">${summary.replace(/\\n/g, '<br>')}</div>
                        <div class="message-actions">
                            <button class="speak-btn" onclick="speakText('${summary.replace(/'/g, "\\'").replace(/\\n/g, ' ')}')">
                                🔊 Lees samenvatting voor
                            </button>
                            <button class="download-btn" onclick="downloadSummary()">
                                📄 Download samenvatting
                            </button>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(summaryMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // Download summary function
        function downloadSummary() {
            const data = window.medicalData;
            let content = "MEDISCHE ANAMNESE SAMENVATTING\\n";
            content += "================================\\n\\n";
            content += `Datum: ${new Date().toLocaleDateString('nl-NL')}\\n\\n`;
            
            if (data.symptoms.length > 0) {
                content += `Symptomen: ${data.symptoms.join(', ')}\\n`;
            }
            if (data.duration) {
                content += `Duur klachten: ${data.duration}\\n`;
            }
            if (data.medications.length > 0) {
                content += `Medicijnen: ${data.medications.join(', ')}\\n`;
            }
            
            content += "\\nAanbeveling: Raadpleeg uw huisarts voor een professionele diagnose.";
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `medische-anamnese-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Text-to-Speech functionality with natural voice optimization
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let availableVoices = [];
        
        function speakText(text) {
            // Stop any current speech
            if (currentUtterance) {
                speechSynthesis.cancel();
            }
            
            // Create new utterance
            currentUtterance = new SpeechSynthesisUtterance(text);
            
            // Configure voice settings for natural Dutch speech
            currentUtterance.lang = 'nl-NL';
            currentUtterance.rate = 1.1; // Slightly faster for more natural flow
            currentUtterance.pitch = 1.0; // Natural pitch
            currentUtterance.volume = 0.9; // Clear volume
            
            // Find the most natural Dutch voice
            const voices = speechSynthesis.getVoices();
            let selectedVoice = null;
            
            // Priority order for natural Dutch voices
            const preferredVoices = [
                // High quality Dutch voices
                'Google Nederlands',
                'Microsoft Hedda - Dutch (Netherlands)',
                'Microsoft Frank - Dutch (Netherlands)', 
                'Xander (Enhanced)', // macOS Dutch voice
                'Claire (Enhanced)', // macOS Dutch voice
                'Ellen', // Windows Dutch voice
                'Lotte', // Windows Dutch voice
                // Fallback to any Dutch voice
                voices.find(voice => voice.lang === 'nl-NL' && voice.name.includes('Neural')),
                voices.find(voice => voice.lang === 'nl-NL' && voice.name.includes('Premium')),
                voices.find(voice => voice.lang === 'nl-NL' && voice.name.includes('Enhanced')),
                voices.find(voice => voice.lang === 'nl-NL'),
                voices.find(voice => voice.lang.startsWith('nl')),
                // Last resort: any natural sounding voice
                voices.find(voice => voice.name.includes('Neural')),
                voices.find(voice => voice.name.includes('Enhanced')),
                voices.find(voice => voice.name.includes('Premium'))
            ];
            
            // Select the first available preferred voice
            for (const voiceName of preferredVoices) {
                if (typeof voiceName === 'string') {
                    selectedVoice = voices.find(voice => voice.name === voiceName);
                } else if (voiceName) {
                    selectedVoice = voiceName;
                }
                if (selectedVoice) break;
            }
            
            if (selectedVoice) {
                currentUtterance.voice = selectedVoice;
                console.log('Using voice:', selectedVoice.name);
            }
            
            // Add natural pauses for better flow
            const processedText = addNaturalPauses(text);
            currentUtterance.text = processedText;
            
            // Add event listeners
            currentUtterance.onstart = () => {
                updateVoiceFeedback('🔊 AI spreekt...');
                // Add visual indication that AI is speaking
                const aiMessages = document.querySelectorAll('.ai-message');
                const lastMessage = aiMessages[aiMessages.length - 1];
                if (lastMessage) {
                    lastMessage.classList.add('speaking');
                }
            };
            
            currentUtterance.onend = () => {
                updateVoiceFeedback('✅ Klaar met spreken. U kunt nu antwoorden.');
                // Remove speaking indication
                const speakingMessages = document.querySelectorAll('.ai-message.speaking');
                speakingMessages.forEach(msg => msg.classList.remove('speaking'));
                currentUtterance = null;
            };
            
            currentUtterance.onerror = (event) => {
                console.error('Speech synthesis error:', event);
                updateVoiceFeedback('❌ Spraak uitvoer mislukt.');
                // Remove speaking indication
                const speakingMessages = document.querySelectorAll('.ai-message.speaking');
                speakingMessages.forEach(msg => msg.classList.remove('speaking'));
                currentUtterance = null;
            };
            
            // Speak the text
            speechSynthesis.speak(currentUtterance);
        }
        
        // Add natural pauses for better speech flow
        function addNaturalPauses(text) {
            return text
                .replace(/\./g, '. ') // Pause after periods
                .replace(/\?/g, '? ') // Pause after questions
                .replace(/!/g, '! ') // Pause after exclamations
                .replace(/,/g, ', ') // Short pause after commas
                .replace(/:/g, ': ') // Pause after colons
                .replace(/;/g, '; ') // Pause after semicolons
                .replace(/\s+/g, ' ') // Clean up multiple spaces
                .trim();
        }
        
        // Initialize voices when available
        function initializeVoices() {
            availableVoices = speechSynthesis.getVoices();
            if (availableVoices.length === 0) {
                speechSynthesis.addEventListener('voiceschanged', () => {
                    availableVoices = speechSynthesis.getVoices();
                    console.log('Available voices:', availableVoices.map(v => `${v.name} (${v.lang})`));
                });
            } else {
                console.log('Available voices:', availableVoices.map(v => `${v.name} (${v.lang})`));
            }
        }
        
        // Initialize voices on page load
        initializeVoices();
    </script>

